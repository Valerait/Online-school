<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Jitsi –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
        }
        .error {
            background: #ef4444;
        }
        .info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .test-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <h1>üé• –¢–µ—Å—Ç Jitsi Meet –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h1>
    
    <div class="container">
        <h2>1. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
        <div>
            <input type="text" id="phone" placeholder="+77001111111" value="+77001111111">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123456">
            <button class="button" onclick="testLogin()">–í–æ–π—Ç–∏ –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç</button>
            <button class="button" onclick="testTeacherLogin()">–í–æ–π—Ç–∏ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</button>
        </div>
        <div id="authResult"></div>
    </div>

    <div class="container">
        <h2>2. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞ —Å Jitsi</h2>
        <div>
            <select id="subject">
                <option value="math">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                <option value="physics">–§–∏–∑–∏–∫–∞</option>
                <option value="chemistry">–•–∏–º–∏—è</option>
            </select>
            <input type="date" id="date" value="">
            <input type="time" id="time" value="14:00">
            <button class="button" onclick="createBooking()">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
        <div id="bookingResult"></div>
    </div>

    <div class="container">
        <h2>3. –¢–µ—Å—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏ (–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å)</h2>
        <div>
            <input type="text" id="bookingId" placeholder="ID –∑–∞—è–≤–∫–∏">
            <button class="button" onclick="acceptBooking()">–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
        <div id="acceptResult"></div>
    </div>

    <div class="container">
        <h2>4. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞</h2>
        <div>
            <input type="text" id="lessonId" placeholder="ID —É—Ä–æ–∫–∞">
            <button class="button" onclick="testLessonData()">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞</button>
        </div>
        <div id="lessonResult"></div>
    </div>

    <div class="container">
        <h2>5. –¢–µ—Å—Ç Jitsi –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞</h2>
        <div class="info">
            <p><strong>–°—Å—ã–ª–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong></p>
            <p>‚Ä¢ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: <a href="http://localhost:3001" target="_blank">http://localhost:3001</a></p>
            <p>‚Ä¢ –¢–µ—Å—Ç Jitsi: <a href="http://localhost:3001/test-jitsi" target="_blank">http://localhost:3001/test-jitsi</a></p>
            <p>‚Ä¢ –í—Ö–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞: <a href="http://localhost:3001/login" target="_blank">http://localhost:3001/login</a></p>
            <p>‚Ä¢ –í—Ö–æ–¥ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: <a href="http://localhost:3001/teacher/login" target="_blank">http://localhost:3001/teacher/login</a></p>
        </div>
    </div>

    <div class="container">
        <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="testResults"></div>
    </div>

    <script>
        const API_BASE = 'https://obzatycdwtdmhgqotbgs.supabase.co/functions/v1';
        let sessionId = null;
        let currentUser = null;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('date').value = new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0];

        function addResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'test-success' : 'test-error'}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            container.appendChild(div);
        }

        async function testLogin() {
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth-v2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.sessionId;
                    currentUser = data.user;
                    addResult('authResult', `‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥: ${data.user.name} (${data.user.role})`);
                    addResult('testResults', `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: –£–°–ü–ï–•`);
                } else {
                    addResult('authResult', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.error}`, false);
                    addResult('testResults', `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: –û–®–ò–ë–ö–ê - ${data.error}`, false);
                }
            } catch (error) {
                addResult('authResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                addResult('testResults', `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: –û–®–ò–ë–ö–ê –°–ï–¢–ò`, false);
            }
        }

        async function testTeacherLogin() {
            try {
                const response = await fetch(`${API_BASE}/teacher-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'teacher@example.com', 
                        password: '123456' 
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.sessionId;
                    currentUser = data.user;
                    addResult('authResult', `‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: ${data.user.name}`);
                    addResult('testResults', `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: –£–°–ü–ï–•`);
                } else {
                    addResult('authResult', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: ${data.error}`, false);
                    addResult('testResults', `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: –û–®–ò–ë–ö–ê - ${data.error}`, false);
                }
            } catch (error) {
                addResult('authResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                addResult('testResults', `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: –û–®–ò–ë–ö–ê –°–ï–¢–ò`, false);
            }
        }

        async function createBooking() {
            if (!sessionId) {
                addResult('bookingResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', false);
                return;
            }

            const subject = document.getElementById('subject').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;

            try {
                const response = await fetch(`${API_BASE}/profile?action=book-lesson&sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject,
                        date,
                        time,
                        type: 'trial'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addResult('bookingResult', `‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ID ${data.booking?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                    addResult('testResults', `–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏: –£–°–ü–ï–•`);
                    if (data.booking?.id) {
                        document.getElementById('bookingId').value = data.booking.id;
                    }
                } else {
                    addResult('bookingResult', `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏: ${data.error}`, false);
                    addResult('testResults', `–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏: –û–®–ò–ë–ö–ê - ${data.error}`, false);
                }
            } catch (error) {
                addResult('bookingResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                addResult('testResults', `–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏: –û–®–ò–ë–ö–ê –°–ï–¢–ò`, false);
            }
        }

        async function acceptBooking() {
            if (!sessionId || currentUser?.role !== 'teacher') {
                addResult('acceptResult', '‚ùå –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å', false);
                return;
            }

            const bookingId = document.getElementById('bookingId').value;
            if (!bookingId) {
                addResult('acceptResult', '‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∑–∞—è–≤–∫–∏', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/teacher-dashboard-v2?action=accept-booking&sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId })
                });

                const data = await response.json();
                
                if (data.success) {
                    addResult('acceptResult', `‚úÖ –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞, —É—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω: ID ${data.lesson?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                    addResult('testResults', `–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏ —Å Jitsi: –£–°–ü–ï–•`);
                    if (data.lesson?.id) {
                        document.getElementById('lessonId').value = data.lesson.id;
                    }
                    if (data.lesson?.meeting_link) {
                        addResult('acceptResult', `üé• Jitsi –∫–æ–º–Ω–∞—Ç–∞: ${data.lesson.meeting_link}`);
                    }
                } else {
                    addResult('acceptResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏: ${data.error}`, false);
                    addResult('testResults', `–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏ —Å Jitsi: –û–®–ò–ë–ö–ê - ${data.error}`, false);
                }
            } catch (error) {
                addResult('acceptResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                addResult('testResults', `–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏ —Å Jitsi: –û–®–ò–ë–ö–ê –°–ï–¢–ò`, false);
            }
        }

        async function testLessonData() {
            if (!sessionId) {
                addResult('lessonResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', false);
                return;
            }

            const lessonId = document.getElementById('lessonId').value;
            if (!lessonId) {
                addResult('lessonResult', '‚ùå –í–≤–µ–¥–∏—Ç–µ ID —É—Ä–æ–∫–∞', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/lesson?lessonId=${lessonId}&sessionId=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    addResult('lessonResult', `‚úÖ –î–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω—ã: ${data.lesson.subject} - ${data.lesson.date}`);
                    addResult('lessonResult', `üé• Jitsi –∫–æ–º–Ω–∞—Ç–∞: ${data.lesson.meeting_link}`);
                    addResult('lessonResult', `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.name} (${data.user.role})`);
                    addResult('testResults', `–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞: –£–°–ü–ï–•`);
                    
                    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —É—Ä–æ–∫
                    const lessonUrl = `http://localhost:3001/lesson/${lessonId}`;
                    addResult('lessonResult', `üîó <a href="${lessonUrl}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ –≤ Next.js</a>`);
                } else {
                    addResult('lessonResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${data.error}`, false);
                    addResult('testResults', `–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞: –û–®–ò–ë–ö–ê - ${data.error}`, false);
                }
            } catch (error) {
                addResult('lessonResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                addResult('testResults', `–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞: –û–®–ò–ë–ö–ê –°–ï–¢–ò`, false);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            addResult('testResults', 'üöÄ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Jitsi –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏');
            addResult('testResults', 'üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: 1) –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç 2) –°–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É 3) –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å 4) –ü—Ä–∏–Ω–∏–º–∏—Ç–µ –∑–∞—è–≤–∫—É 5) –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞');
        };
    </script>
</body>
</html>