<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
        }
        .error {
            background: #ef4444;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏</h1>
    
    <div class="container">
        <h2>1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h2>
        <input type="email" id="email" placeholder="teacher@example.com" value="teacher@example.com">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123456">
        <button class="button" onclick="loginTeacher()">–í–æ–π—Ç–∏</button>
        <div id="loginResult"></div>
    </div>

    <div class="container">
        <h2>2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫</h2>
        <button class="button" onclick="getBookings()">–ü–æ–ª—É—á–∏—Ç—å –∑–∞—è–≤–∫–∏</button>
        <div id="bookingsResult"></div>
    </div>

    <div class="container">
        <h2>3. –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏</h2>
        <input type="text" id="bookingId" placeholder="ID –∑–∞—è–≤–∫–∏ (–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)">
        <button class="button" onclick="acceptBooking()">–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É</button>
        <div id="acceptResult"></div>
    </div>

    <script>
        const API_BASE = 'https://obzatycdwtdmhgqotbgs.supabase.co/functions/v1';
        let sessionId = null;

        function addResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            container.appendChild(div);
        }

        async function loginTeacher() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/teacher-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.sessionId;
                    addResult('loginResult', `‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥: ${data.user.name} (ID: ${data.user.id})`);
                } else {
                    addResult('loginResult', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.error}`, false);
                }
            } catch (error) {
                addResult('loginResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        async function getBookings() {
            if (!sessionId) {
                addResult('bookingsResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/teacher-dashboard-v2?action=bookings&sessionId=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    addResult('bookingsResult', `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –∑–∞—è–≤–æ–∫: ${data.bookings.length}`);
                    
                    if (data.bookings.length > 0) {
                        const pendingBookings = data.bookings.filter(b => b.status === 'pending');
                        if (pendingBookings.length > 0) {
                            document.getElementById('bookingId').value = pendingBookings[0].id;
                            addResult('bookingsResult', `üìã –ü–µ—Ä–≤–∞—è –∑–∞—è–≤–∫–∞: ${pendingBookings[0].subject} - ${pendingBookings[0].date} ${pendingBookings[0].time}`);
                        } else {
                            addResult('bookingsResult', '‚ö†Ô∏è –ù–µ—Ç –∑–∞—è–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"');
                        }
                    }
                    
                    addResult('bookingsResult', `–î–µ—Ç–∞–ª–∏: ${JSON.stringify(data.bookings, null, 2)}`);
                } else {
                    addResult('bookingsResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫: ${data.error}`, false);
                }
            } catch (error) {
                addResult('bookingsResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        async function acceptBooking() {
            if (!sessionId) {
                addResult('acceptResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', false);
                return;
            }

            const bookingId = document.getElementById('bookingId').value;
            if (!bookingId) {
                addResult('acceptResult', '‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∑–∞—è–≤–∫–∏', false);
                return;
            }

            try {
                addResult('acceptResult', `üîÑ –ü—Ä–∏–Ω–∏–º–∞—é –∑–∞—è–≤–∫—É ${bookingId}...`);
                
                const response = await fetch(`${API_BASE}/teacher-dashboard-v2?action=accept-booking&sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId })
                });

                const data = await response.json();
                
                addResult('acceptResult', `üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success) {
                    addResult('acceptResult', `‚úÖ –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –£—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω: ${data.lesson?.id}`);
                    if (data.lesson?.meeting_link) {
                        addResult('acceptResult', `üé• Jitsi –∫–æ–º–Ω–∞—Ç–∞: ${data.lesson.meeting_link}`);
                    }
                } else {
                    addResult('acceptResult', `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, false);
                }
            } catch (error) {
                addResult('acceptResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                console.error('Full error:', error);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            addResult('loginResult', 'üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
        };
    </script>
</body>
</html>