<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —á–∏—Å—Ç–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
        }
        .error {
            background: #ef4444;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —á–∏—Å—Ç–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h1>
    
    <div class="info">
        <h3>üìã –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ:</h3>
        <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> +77001111111 / 123456 (–ñ–∞–Ω–∞—Ç –•)</p>
        <p><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> teacher@example.com / 123456 (–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–Ω–∞)</p>
        <p><strong>–ê–¥–º–∏–Ω:</strong> +77003333333 / 123456 (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)</p>
        <p><strong>–ü—Ä–µ–¥–º–µ—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:</strong> –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –§–∏–∑–∏–∫–∞</p>
        <p><strong>–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞:</strong> –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –∑–∞–≤—Ç—Ä–∞ 12:00</p>
    </div>

    <div class="container">
        <h2>1. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</h2>
        <input type="text" id="studentPhone" value="+77001111111">
        <input type="password" id="studentPassword" value="123456">
        <button class="button" onclick="testStudentLogin()">–í–æ–π—Ç–∏ –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç</button>
        <div id="studentResult"></div>
    </div>

    <div class="container">
        <h2>2. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h2>
        <input type="email" id="teacherEmail" value="teacher@example.com">
        <input type="password" id="teacherPassword" value="123456">
        <button class="button" onclick="testTeacherLogin()">–í–æ–π—Ç–∏ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</button>
        <div id="teacherResult"></div>
    </div>

    <div class="container">
        <h2>3. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º</h2>
        <button class="button" onclick="getTeacherBookings()">–ü–æ–ª—É—á–∏—Ç—å –∑–∞—è–≤–∫–∏</button>
        <div id="bookingsResult"></div>
    </div>

    <div class="container">
        <h2>4. –¢–µ—Å—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏</h2>
        <input type="text" id="bookingId" placeholder="ID –∑–∞—è–≤–∫–∏ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)">
        <button class="button" onclick="acceptBooking()">–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É</button>
        <div id="acceptResult"></div>
    </div>

    <div class="container">
        <h2>5. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞</h2>
        <input type="text" id="lessonId" placeholder="ID —É—Ä–æ–∫–∞ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)">
        <button class="button" onclick="testLessonData()">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞</button>
        <div id="lessonResult"></div>
    </div>

    <div class="container">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="summaryResult"></div>
    </div>

    <script>
        const API_BASE = 'https://obzatycdwtdmhgqotbgs.supabase.co/functions/v1';
        let studentSessionId = null;
        let teacherSessionId = null;
        let testResults = [];

        function addResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            container.appendChild(div);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            testResults.push({
                test: containerId.replace('Result', ''),
                success: isSuccess,
                message: message
            });
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summaryResult');
            const passed = testResults.filter(r => r.success).length;
            const total = testResults.length;
            
            summary.innerHTML = `
                <div class="result ${passed === total ? 'success' : 'error'}">
                    –ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: ${passed}/${total}
                    ${passed === total ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏'}
                </div>
            `;
        }

        async function testStudentLogin() {
            const phone = document.getElementById('studentPhone').value;
            const password = document.getElementById('studentPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth-v2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    studentSessionId = data.sessionId;
                    addResult('studentResult', `‚úÖ –°—Ç—É–¥–µ–Ω—Ç –≤–æ—à–µ–ª: ${data.user.name} (${data.user.role})`);
                } else {
                    addResult('studentResult', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞: ${data.error}`, false);
                }
            } catch (error) {
                addResult('studentResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        async function testTeacherLogin() {
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;

            try {
                const response = await fetch(`${API_BASE}/teacher-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    teacherSessionId = data.sessionId;
                    addResult('teacherResult', `‚úÖ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª: ${data.user.name} (${data.user.role})`);
                } else {
                    addResult('teacherResult', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: ${data.error}`, false);
                }
            } catch (error) {
                addResult('teacherResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        async function getTeacherBookings() {
            if (!teacherSessionId) {
                addResult('bookingsResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/teacher-dashboard-v2?action=bookings&sessionId=${teacherSessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    addResult('bookingsResult', `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –∑–∞—è–≤–æ–∫: ${data.bookings.length}`);
                    
                    const pendingBookings = data.bookings.filter(b => b.status === 'pending');
                    if (pendingBookings.length > 0) {
                        document.getElementById('bookingId').value = pendingBookings[0].id;
                        addResult('bookingsResult', `üìã –ù–∞–π–¥–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${pendingBookings[0].subject} - ${pendingBookings[0].date}`);
                    } else {
                        addResult('bookingsResult', '‚ö†Ô∏è –ù–µ—Ç –∑–∞—è–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"');
                    }
                } else {
                    addResult('bookingsResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫: ${data.error}`, false);
                }
            } catch (error) {
                addResult('bookingsResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        async function acceptBooking() {
            if (!teacherSessionId) {
                addResult('acceptResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å', false);
                return;
            }

            const bookingId = document.getElementById('bookingId').value;
            if (!bookingId) {
                addResult('acceptResult', '‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∑–∞—è–≤–∫–∏', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/teacher-dashboard-v2?action=accept-booking&sessionId=${teacherSessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId })
                });

                const data = await response.json();
                
                if (data.success) {
                    addResult('acceptResult', `‚úÖ –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –£—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω: ${data.lesson?.id}`);
                    if (data.lesson?.meeting_link) {
                        addResult('acceptResult', `üé• Jitsi –∫–æ–º–Ω–∞—Ç–∞: ${data.lesson.meeting_link}`);
                        document.getElementById('lessonId').value = data.lesson.id;
                    }
                } else {
                    addResult('acceptResult', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏: ${data.error}`, false);
                }
            } catch (error) {
                addResult('acceptResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        async function testLessonData() {
            if (!teacherSessionId) {
                addResult('lessonResult', '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å', false);
                return;
            }

            const lessonId = document.getElementById('lessonId').value;
            if (!lessonId) {
                addResult('lessonResult', '‚ùå –í–≤–µ–¥–∏—Ç–µ ID —É—Ä–æ–∫–∞', false);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/lesson?lessonId=${lessonId}&sessionId=${teacherSessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    addResult('lessonResult', `‚úÖ –î–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω—ã: ${data.lesson.subject} - ${data.lesson.date}`);
                    addResult('lessonResult', `üé• Jitsi –∫–æ–º–Ω–∞—Ç–∞: ${data.lesson.meeting_link}`);
                    addResult('lessonResult', `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.name} (${data.user.role})`);
                    
                    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —É—Ä–æ–∫
                    const lessonUrl = `http://localhost:3001/lesson/${lessonId}`;
                    addResult('lessonResult', `üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —É—Ä–æ–∫: ${lessonUrl}`);
                } else {
                    addResult('lessonResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞: ${data.error}`, false);
                }
            } catch (error) {
                addResult('lessonResult', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
        window.onload = function() {
            addResult('summaryResult', 'üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å—Ç–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∞—Ç–æ');
        };
    </script>
</body>
</html>